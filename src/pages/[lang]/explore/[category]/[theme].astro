---
import MainLayout from "@/layouts/MainLayout.astro";
import Header from "@/components/layout/Header.astro";
import Footer from "@/components/layout/Footer.astro";
import ThemeDock from "@/components/ui/ThemeDock.astro";
import {
    portfolioThemesEN,
    portfolioThemesTW,
} from "@/data/themes/portfolioData";
import {
    ecommerceThemesEN,
    ecommerceThemesTW,
} from "@/data/themes/ecommerceData";
import {
    corporateThemesEN,
    corporateThemesTW,
} from "@/data/themes/corporateData";
import {
    contentNewsThemesEN,
    contentNewsThemesTW,
} from "@/data/themes/contentNewsData";
import { softwareThemesEN, softwareThemesTW } from "@/data/themes/softwareData";
import { getRelativeLocaleUrl } from "astro:i18n";

// Portfolio Components
import WaterfallGridLayout from "@/components/themes/portfolio/WaterfallGridLayout.astro";
import StandardDividedLayout from "@/components/themes/portfolio/StandardDividedLayout.astro";
import LongPageLandingLayout from "@/components/themes/portfolio/LongPageLandingLayout.astro";
import FullBleedCarouselLayout from "@/components/themes/portfolio/FullBleedCarouselLayout.astro";
import StructuredCaseStudyLayout from "@/components/themes/portfolio/StructuredCaseStudyLayout.astro";

// E-Commerce Components
import EditorialMagazineLayout from "@/components/themes/ecommerce/EditorialMagazineLayout.astro";
import TechElectronicsLayout from "@/components/themes/ecommerce/TechElectronicsLayout.astro";
import SubscriptionLandingLayout from "@/components/themes/ecommerce/SubscriptionLandingLayout.astro";
import FoodGroceryLayout from "@/components/themes/ecommerce/FoodGroceryLayout.astro";
import DigitalProductLayout from "@/components/themes/ecommerce/DigitalProductLayout.astro";

// Corporate Components
import StrictProfessionalLayout from "@/components/themes/corporate/StrictProfessionalLayout.astro";
import IndustrialModularLayout from "@/components/themes/corporate/IndustrialModularLayout.astro";
import NonProfitImpactLayout from "@/components/themes/corporate/NonProfitImpactLayout.astro";
import RestaurantVisualLayout from "@/components/themes/corporate/RestaurantVisualLayout.astro";
import MedicalClinicLayout from "@/components/themes/corporate/MedicalClinicLayout.astro";

// Content/News Components
import ThreeColumnReviewLayout from "@/components/themes/contentNews/ThreeColumnReviewLayout.astro";
import StructuredRecipeLayout from "@/components/themes/contentNews/StructuredRecipeLayout.astro";
import TravelVisualStoryLayout from "@/components/themes/contentNews/TravelVisualStoryLayout.astro";
import GossipDenseGridLayout from "@/components/themes/contentNews/GossipDenseGridLayout.astro";
import AcademicMinimalLayout from "@/components/themes/contentNews/AcademicMinimalLayout.astro";

// Software/SaaS Components
import FreemiumSinglePageLayout from "@/components/themes/software/FreemiumSinglePageLayout.astro";
import EnterpriseSalesLayout from "@/components/themes/software/EnterpriseSalesLayout.astro";
import MobileAppVerticalLayout from "@/components/themes/software/MobileAppVerticalLayout.astro";
import ProjectManagementKanbanLayout from "@/components/themes/software/ProjectManagementKanbanLayout.astro";
import FintechDataLayout from "@/components/themes/software/FintechDataLayout.astro";

const ComponentMap = {
    // Portfolio
    WaterfallGridLayout,
    StandardDividedLayout,
    LongPageLandingLayout,
    FullBleedCarouselLayout,
    StructuredCaseStudyLayout,
    // E-Commerce
    EditorialMagazineLayout,
    TechElectronicsLayout,
    SubscriptionLandingLayout,
    FoodGroceryLayout,
    DigitalProductLayout,
    // Corporate
    StrictProfessionalLayout,
    IndustrialModularLayout,
    NonProfitImpactLayout,
    RestaurantVisualLayout,
    MedicalClinicLayout,
    // Content/News
    ThreeColumnReviewLayout,
    StructuredRecipeLayout,
    TravelVisualStoryLayout,
    GossipDenseGridLayout,
    AcademicMinimalLayout,
    // Software/SaaS
    FreemiumSinglePageLayout,
    EnterpriseSalesLayout,
    MobileAppVerticalLayout,
    ProjectManagementKanbanLayout,
    FintechDataLayout,
};

const { lang, category, theme } = Astro.params;

// Helper to get themes based on lang and category
function getThemes(cat: string | undefined, l: string | undefined) {
    if (cat === "portfolio") {
        return l === "zh-tw" ? portfolioThemesTW : portfolioThemesEN;
    }
    if (cat === "ecommerce") {
        return l === "zh-tw" ? ecommerceThemesTW : ecommerceThemesEN;
    }
    if (cat === "corporate") {
        return l === "zh-tw" ? corporateThemesTW : corporateThemesEN;
    }
    if (cat === "content-news") {
        return l === "zh-tw" ? contentNewsThemesTW : contentNewsThemesEN;
    }
    if (cat === "software") {
        return l === "zh-tw" ? softwareThemesTW : softwareThemesEN;
    }
    return [];
}

const themes = getThemes(category, lang);
const activeTheme = themes.find((t) => t.id === theme);

if (!lang || !category || !activeTheme) {
    return Astro.redirect("/404");
}

// Link generation helper
function getThemeLink(lang: string, category: string, themeId: string) {
    // Manually construct because getRelativeLocaleUrl might produce encoded paths differently
    return `/${lang}/explore/${category}/${themeId}`;
}
---

<MainLayout title={`Explorer - ${category}`} lang={lang}>
    <Header />

    <main class="pt-20 min-h-screen bg-slate-50 dark:bg-slate-900">
        <div class="max-w-7xl mx-auto px-4 py-8">
            <h1
                class="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-primary-600 to-purple-600 mb-4 capitalize"
            >
                {category} Explorer
            </h1>

            <!-- Floating Theme Dock -->
            <ThemeDock
                themes={themes}
                activeThemeId={activeTheme.id}
                lang={lang}
                category={category}
            />

            <!-- Preview Area -->
            <div
                class={`transition-all duration-500 rounded-xl overflow-hidden shadow-2xl border border-slate-200 dark:border-slate-800 ${activeTheme.styleClasses}`}
            >
                {
                    (() => {
                        const Layout =
                            ComponentMap[
                                activeTheme.layoutComponent as keyof typeof ComponentMap
                            ] || WaterfallGridLayout;
                        return <Layout theme={activeTheme} />;
                    })()
                }
            </div>
        </div>
    </main>

    <Footer />
</MainLayout>
